<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Arbitragem BIN/ROX</title>
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Web3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.9.0/web3.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0f1218;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }
        .container {
            background-color: #1b1f26;
            width: 100%;
            max-width: 450px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 1px solid #2b3139;
        }
        h2 { text-align: center; color: #f0b90b; margin-top: 0; font-size: 1.5rem; }
        .logo-area { text-align: center; margin-bottom: 20px; color: #f0b90b; font-size: 2rem; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #848e9c; font-weight: 600; }
        
        input, select {
            width: 100%;
            padding: 14px;
            background-color: #0f1218;
            border: 1px solid #2b3139;
            border-radius: 8px;
            color: white;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border 0.3s;
        }
        input:focus, select:focus { border-color: #f0b90b; outline: none; }

        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #f0b90b 0%, #d0a009 100%);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(240, 185, 11, 0.3); }
        button:disabled { background: #333; color: #777; cursor: not-allowed; transform: none; }

        .status-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #000;
            border-radius: 8px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            color: #0ecb81;
            height: 150px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .log-error { color: #f6465d; }
        .log-warn { color: #f0b90b; }
        
        .contract-tag {
            text-align: center;
            font-size: 0.75rem;
            color: #555;
            margin-top: 5px;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-area">
        <i class="fa-solid fa-layer-group"></i>
    </div>
    <h2>Arbitragem Flash Loan</h2>
    
    <div class="form-group">
        <button id="btnConnect" onclick="connectWallet()">
            <i class="fa-solid fa-wallet"></i> Conectar Carteira
        </button>
    </div>

    <div class="form-group">
        <label>Token Alvo:</label>
        <select id="targetChoice">
            <option value="0">Rota A: WBNB -> BIN -> ROX -> WBNB</option>
            <option value="1">Rota B: WBNB -> ROX -> BIN -> WBNB</option>
        </select>
    </div>

    <div class="form-group">
        <label>Valor do Flash Loan (BNB):</label>
        <input type="number" id="loanAmount" placeholder="Ex: 10" step="0.1">
    </div>

    <div class="form-group">
        <button id="btnExecute" onclick="executeArbitrage()" disabled>
            <i class="fa-solid fa-bolt"></i> Executar Operação
        </button>
    </div>

    <div class="status-box" id="logBox">
        <div>> Sistema pronto.</div>
        <div>> Aguardando conexão...</div>
    </div>
    
    <div class="contract-tag">
        Contrato: 0xa13A446b...753Dc
    </div>
</div>

<script>
    // --- CONFIGURAÇÃO ---
    const CONTRACT_ADDRESS = "0xa13A446bb72b45D758D364788Ae6fF94F0c753Dc";

    // ABI do Contrato
    const contractABI = [
        {
            "inputs": [
                {"internalType": "address", "name": "_routerAddress", "type": "address"},
                {"internalType": "address", "name": "_poolAddress", "type": "address"}
            ],
            "stateMutability": "nonpayable",
            "type": "constructor"
        },
        {
            "inputs": [],
            "name": "owner",
            "outputs": [{"internalType": "address", "name": "", "type": "address"}],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {"internalType": "uint256", "name": "_amount", "type": "uint256"},
                {"internalType": "uint8", "name": "_targetChoice", "type": "uint8"}
            ],
            "name": "executeArbitrage",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [{"internalType": "address", "name": "_token", "type": "address"}],
            "name": "withdraw",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        }
    ];

    let web3;
    let userAccount;
    let contractInstance;

    function log(msg, type = 'info') {
        const box = document.getElementById('logBox');
        const entry = document.createElement('div');
        if (type === 'error') entry.className = 'log-error';
        if (type === 'warn') entry.className = 'log-warn';
        entry.textContent = `> ${msg}`;
        box.appendChild(entry);
        box.scrollTop = box.scrollHeight;
    }

    async function connectWallet() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = (await web3.eth.getAccounts())[0];
                
                // Atualiza UI
                document.getElementById('btnConnect').innerHTML = `Conectado: ${userAccount.substring(0,6)}...${userAccount.substring(38)}`;
                document.getElementById('btnConnect').disabled = true;
                document.getElementById('btnConnect').style.background = "#0ecb81";
                document.getElementById('btnConnect').style.color = "white";
                document.getElementById('btnExecute').disabled = false;
                
                // Verificar Rede
                const chainId = await web3.eth.getChainId();
                if(chainId !== 56) {
                    log(`Atenção: Você está na Chain ID ${chainId}. Mude para BSC Mainnet (56).`, 'warn');
                } else {
                    log("Carteira conectada à BSC Mainnet.", 'info');
                }

            } catch (error) {
                log("Erro ao conectar: " + error.message, 'error');
            }
        } else {
            log("MetaMask/Rabby não encontrada.", 'error');
        }
    }

    async function executeArbitrage() {
        const amount = document.getElementById('loanAmount').value;
        const target = document.getElementById('targetChoice').value;

        if (!amount) {
            alert("Por favor, insira o valor do Flash Loan.");
            return;
        }

        contractInstance = new web3.eth.Contract(contractABI, CONTRACT_ADDRESS);
        const amountWei = web3.utils.toWei(amount, 'ether');
        const targetInt = parseInt(target);

        log("Iniciando operação de Flash Loan...", 'info');
        document.getElementById('btnExecute').disabled = true;
        document.getElementById('btnExecute').innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Processando...`;

        try {
            // Estimar Gas
            const gas = await contractInstance.methods.executeArbitrage(amountWei, targetInt).estimateGas({ from: userAccount });
            log(`Gas estimado: ${gas} unidades`, 'info');

            // Enviar Transação
            const result = await contractInstance.methods.executeArbitrage(amountWei, targetInt).send({
                from: userAccount,
                gas: Math.floor(gas * 1.2) // 20% de margem
            });

            log(`SUCESSO! Transação: ${result.transactionHash}`, 'info');
            log("Verifique seus lucros no saldo do contrato (Withdraw).", 'warn');

        } catch (error) {
            console.error(error);
            log("FALHA NA OPERAÇÃO:", 'error');
            
            // Tentativa de traduzir o erro
            let errorMsg = "Erro desconhecido. Verifique o console.";
            
            // Verificações comuns de reverter
            if (error.message.includes("revert")) {
                if (error.data) {
                    // Em produção real, decodificariamos o erro do contrato
                    errorMsg = "Transação revertida. Possíveis causas:";
                    errorMsg += "\n1. Sem lucro suficiente (Market ineficiente).";
                    errorMsg += "\n2. Taxas dos tokens (BIN/ROX) muito altas.";
                    errorMsg += "\n3. Slippage (Mudança de preço durante o swap).";
                } else {
                    errorMsg = "Revertido por 'require(false)' (Geralmente falta de lucro).";
                }
            } else {
                errorMsg = error.message;
            }
            
            log(errorMsg, 'error');
        } finally {
            document.getElementById('btnExecute').disabled = false;
            document.getElementById('btnExecute').innerHTML = `<i class="fa-solid fa-bolt"></i> Executar Operação`;
        }
    }
</script>

</body>
</html>
