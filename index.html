<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polygon Arbitrage Bot - Corrigido v4.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- IMPORTANTE: Web3 versão 4.0.3 ou superior -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.0.3/web3.min.js"></script>
    <style>
        :root {
            --primary-color: #8247e5;
            --secondary-color: #2e2e2e;
            --accent-color: #00d395;
            --text-color: #ffffff;
            --background-color: #111827;
            --card-bg: #1f2937;
            --success-color: #10b981;
            --error-color: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        .logo { font-size: 2.5rem; color: var(--accent-color); margin-bottom: 10px; }
        h1 { font-size: 2rem; color: var(--accent-color); margin-bottom: 5px; }
        .subtitle { color: #9ca3af; font-size: 1.1rem; }

        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid #374151;
        }

        .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; color: var(--primary-color); font-size: 1.5rem; font-weight: bold; }
        
        .wallet-info { display: flex; flex-direction: column; gap: 10px; }
        .info-row { display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-family: monospace; font-size: 0.9rem; }
        .label { color: #9ca3af; font-weight: 600; }
        
        .balance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .balance-card { background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #4b5563; }
        .amount { font-size: 1.8rem; font-weight: bold; color: var(--accent-color); margin: 10px 0; }
        .token-name { color: #9ca3af; font-size: 0.9rem; }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-connect { background-color: var(--primary-color); color: white; }
        .btn-connect:hover { background-color: #6c2bd9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(130, 71, 229, 0.4); }
        
        .btn-action { background-color: var(--secondary-color); border: 1px solid var(--primary-color); color: white; }
        .btn-action:hover { background-color: var(--primary-color); }
        
        .btn-withdraw { background-color: var(--success-color); color: white; }
        .btn-withdraw:hover { background-color: #059669; }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: grayscale(1); }
        
        .status-log {
            background-color: #000;
            color: #10b981;
            font-family: monospace;
            padding: 15px;
            border-radius: 8px;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
            font-size: 0.85rem;
            margin-top: 20px;
        }
        .log-err { color: #ef4444; }
        .log-warn { color: #f59e0b; }
        .log-info { color: #3b82f6; }

        .contract-addr {
            font-family: monospace;
            color: #6b7280;
            text-align: center;
            margin-top: 20px;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo"><i class="fas fa-robot"></i></div>
        <h1>Polygon Arbitrage Bot</h1>
        <p class="subtitle">Gerenciamento de Lucros (v4.0 - Web3 4.0.3)</p>
    </header>

    <div class="card">
        <div class="card-header">
            <i class="fas fa-wallet"></i> <span>Carteira</span>
        </div>

        <div class="wallet-info">
            <div class="info-row">
                <span class="label">Status:</span>
                <span id="statusText">Desconectado</span>
            </div>
            <div class="info-row">
                <span class="label">Endereço:</span>
                <span id="addressText">---</span>
            </div>
            <div class="info-row">
                <span class="label">Rede:</span>
                <span id="networkText">---</span>
            </div>
            <div class="info-row">
                <span class="label">Saldo POL:</span>
                <span id="maticBal">0</span>
            </div>
        </div>

        <button id="btnConnect" class="btn btn-connect" onclick="connectWallet()">
            <i class="fas fa-plug"></i> CONECTAR CARTEIRA
        </button>
    </div>

    <div class="card">
        <div class="card-header">
            <i class="fas fa-coins"></i> <span>Saldos do Contrato</span>
        </div>
        <div class="balance-grid">
            <div class="balance-card">
                <div class="token-name">USDT</div>
                <div class="amount" id="usdtBal">0.00</div>
            </div>
            <div class="balance-card">
                <div class="token-name">WBTC</div>
                <div class="amount" id="wbtcBal">0.00</div>
            </div>
            <div class="balance-card">
                <div class="token-name">WMATIC</div>
                <div class="amount" id="wmaticBal">0.00</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 20px; margin-top: 25px;">
            <button id="btnWithdrawAll" class="btn btn-withdraw" style="flex: 1;" onclick="withdrawAll()" disabled>
                <i class="fas fa-money-bill-wave"></i> SACAR TODOS OS FUNDOS
            </button>
            <button id="btnRefresh" class="btn btn-action" style="flex: 1;" onclick="refreshBalances()">
                <i class="fas fa-sync-alt"></i> ATUALIZAR
            </button>
        </div>

        <div class="status-log" id="statusBox">
            <div class="log-info">Sistema carregado... (Web3 v4.0.3)</div>
        </div>
    </div>

    <div class="contract-addr">
        Contrato: 0x353a3834047b769f4c38365f22257e7e32d38710
    </div>
</div>

<script>
    // Configurações
    const CONTRACT_ADDRESS = "0x353a3834047b769f4c38365f22257e7e32d38710";
    const POLYGON_CHAIN_ID = "0x89"; // 137 em Hex

    // Tokens
    const TOKENS = {
        USDT: "0xc2132D05D31c914a87C6611C10748AEb04B58e8F",
        WBTC: "0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6",
        WMATIC: "0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270"
    };

    // ABI Genérica e Robusta
    const ABI_CONTRACT = [
        { "inputs": [], "name": "USDT", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "WBTC", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "WMATIC", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "aavePool", "outputs": [{"internalType": "contract IPool", "name": "", "type": "address"}], "stateMutability": "view", "type": "function" },
        { "inputs": [{"internalType": "uint256", "name": "_amount", "type": "uint256"}], "name": "executeArbitrage", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [{"internalType": "address[]", "name": "assets", "type": "address[]"}, {"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"}, {"internalType": "uint256[]", "name": "premiums", "type": "uint256[]"}, {"internalType": "address", "name": "initiator", "type": "address"}, {"internalType": "bytes", "name": "params", "type": "bytes"}], "name": "executeOperation", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [], "name": "owner", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function" },
        { "inputs": [{"internalType": "address", "name": "_token", "type": "address"}], "name": "withdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [{"internalType": "address", "name": "_token", "type": "address"}, {"internalType": "address", "name": "_to", "type": "address"}], "name": "withdrawTo", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
    ];

    const ABI_ERC20 = [
        { "inputs": [{"internalType": "address", "name": "account", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "decimals", "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}], "stateMutability": "view", "type": "function" }
    ];

    let web3;
    let userAccount;
    let contractInstance;
    let tokenInstances = {};

    // Elementos DOM
    const btnConnect = document.getElementById('btnConnect');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnWithdrawAll = document.getElementById('btnWithdrawAll');
    const statusBox = document.getElementById('statusBox');

    function log(msg, type = 'info') {
        const entry = document.createElement('div');
        if (type === 'error') entry.className = 'log-err';
        if (type === 'warn') entry.className = 'log-warn';
        if (type === 'info') entry.className = 'log-info';
        entry.textContent = `> ${msg}`;
        statusBox.appendChild(entry);
        statusBox.scrollTop = statusBox.scrollHeight;
    }

    // Função de Conexão (Web3 4.0.3 EIP-1193)
    async function connectWallet() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                web3 = new Web3(window.ethereum);
                
                // EIP-1193: Solicita permissão e contas
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];

                // Verifica se tem as permissões
                const permissions = await window.ethereum.request({ method: 'eth_getAccounts' });
                
                uiUpdateConnected(true, userAccount);
                
                // Verifica rede
                const chainId = await web3.eth.getChainId();
                if (chainId !== POLYGON_CHAIN_ID) {
                    log("AVISO: Você não está na Polygon. Tentando mudar...", 'warn');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: POLYGON_CHAIN_ID }]
                        });
                    } catch (switchError) {
                        log("Erro ao trocar rede. Mude manualmente.", 'error');
                    }
                }

                initContracts();
                await refreshBalances();

            } catch (error) {
                console.error(error);
                log("Erro de conexão: " + error.message, 'error');
            }
        } else {
            log("MetaMask não instalada.", 'error');
        }
    }

    async function initContracts() {
        // Contrato Principal
        contractInstance = new web3.eth.Contract(ABI_CONTRACT, CONTRACT_ADDRESS);
        
        // Instâncias dos Tokens
        for (const [symbol, addr] of Object.entries(TOKENS)) {
            tokenInstances[symbol] = new web3.eth.Contract(ABI_ERC20, addr);
        }
    }

    async function refreshBalances() {
        if (!userAccount || !contractInstance) return;
        log("Atualizando saldos...", 'info');
        
        try {
            // Saldo POL
            const maticBal = await web3.eth.getBalance(userAccount);
            document.getElementById('maticBal').textContent = web3.utils.fromWei(maticBal, 'ether');

            // Saldos dos Tokens (Carteira)
            // (O contrato começa zerado, então saldo na carteira = total)
            
            // USDT
            const usdtBal = await tokenInstances.USDT.methods.balanceOf(userAccount).call();
            const usdtDec = await tokenInstances.USDT.methods.decimals().call();
            document.getElementById('usdtBal').textContent = parseFloat(web3.utils.fromWei(usdtBal, usdtDec)).toFixed(2);

            // WBTC
            const wbtcBal = await tokenInstances.WBTC.methods.balanceOf(userAccount).call();
            const wbtcDec = await tokenInstances.WBTC.methods.decimals().call();
            document.getElementById('wbtcBal').textContent = parseFloat(web3.utils.fromWei(wbtcBal, wbtcDec)).toFixed(4);

            // WMATIC
            const wmaticBal = await tokenInstances.WMATIC.methods.balanceOf(userAccount).call();
            const wmaticDec = await tokenInstances.WMATIC.methods.decimals().call();
            document.getElementById('wmaticBal').textContent = parseFloat(web3.utils.fromWei(wmaticBal, wmaticDec)).toFixed(2);

            // Verifica Dono para liberar saque
            try {
                const owner = await contractInstance.methods.owner().call();
                if (userAccount.toLowerCase() !== owner.toLowerCase()) {
                    log("ALERTA: Você não é o dono do contrato.", 'warn');
                    btnWithdrawAll.disabled = true;
                } else {
                    btnWithdrawAll.disabled = false;
                }
            } catch (e) {
                // Opcional: se o contrato não tiver owner
            }

            log("Saldos atualizados.", 'info');

        } catch (e) {
            log("Erro ao ler saldos: " + e.message, 'error');
        }
    }

    async function withdrawAll() {
        if (!contractInstance) return;
        try {
            log("Iniciando saque de todos os tokens...", 'info');
            btnWithdrawAll.disabled = true;

            // Sequência de saques para evitar Nonce
            const tokensToWithdraw = [TOKENS.USDT, TOKENS.WBTC, TOKENS.WMATIC];
            
            for (const tokenAddr of tokensToWithdraw) {
                try {
                    const gas = await contractInstance.methods.withdraw(tokenAddr).estimateGas({ from: userAccount });
                    const tx = await contractInstance.methods.withdraw(tokenAddr).send({
                        from: userAccount,
                        gas: Math.floor(gas * 1.2)
                    });
                    log(`Saque de ${tokenAddr} enviado: ${tx.transactionHash}`, 'info');
                    
                    // Aguarda o bloco para o nonce atualizar
                    await web3.eth.waitForTransactionReceipt(tx.transactionHash);
                } catch (err) {
                    log(`Erro ao sacar ${tokenAddr}: ${err.message}`, 'warn');
                }
            }

            log("Saque total concluído.", 'info');
            await refreshBalances();
            btnWithdrawAll.disabled = false;

        } catch (e) {
            log("Erro no saque: " + e.message, 'error');
            btnWithdrawAll.disabled = false;
        }
    }

    function uiUpdateConnected(connected, account) {
        if (connected) {
            btnConnect.innerHTML = '<i class="fas fa-wallet"></i> CONECTADO';
            btnConnect.classList.add('btn-action');
            document.getElementById('statusText').textContent = "Ativo";
            document.getElementById('statusText').style.color = "#10b981";
            document.getElementById('addressText').textContent = `${account.substring(0,6)}...${account.substring(account.length - 4)}`;
            document.getElementById('networkText').textContent = "Polygon Mainnet";
        } else {
            btnConnect.innerHTML = '<i class="fas fa-plug"></i> CONECTAR';
            btnConnect.classList.remove('btn-action');
            document.getElementById('statusText').textContent = "Desconectado";
            document.getElementById('statusText').style.color = "#ef4444";
            document.getElementById('addressText').textContent = "---";
        }
    }
    
    // Listener de mudança de rede (Web3 4.0)
    if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
            if (accounts.length > 0) {
                userAccount = accounts[0];
                uiUpdateConnected(true, userAccount);
                if (web3) refreshBalances();
            } else {
                uiUpdateConnected(false, null);
            }
        });

        window.ethereum.on('chainChanged', (chainId) => {
            if (chainId === POLYGON_CHAIN_ID) {
                document.getElementById('networkText').textContent = "Polygon Mainnet";
                if (web3 && userAccount) refreshBalances();
            } else {
                document.getElementById('networkText').textContent = "Rede Incorreta";
            }
        });
    }

</script>

</body>
</html>
