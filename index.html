<!DOCTYPE html>
<html>
<head>
    <title>Balance Consolidator - BSC</title>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --success: #00d26a;
            --danger: #ff0080;
            --warning: #ffb800;
            --dark: #0f0f0f;
            --darker: #0a0a0a;
            --light: #1a1a1a;
            --lighter: #2d2d2d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark);
            color: #fff;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary), #42a5f5);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: var(--light);
            border: 1px solid var(--lighter);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--lighter);
        }
        
        .card h3 {
            color: var(--primary);
            font-size: 1.3em;
            margin: 0;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-warning {
            background: var(--warning);
            color: #000;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ccc;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            background: var(--darker);
            border: 1px solid var(--lighter);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--lighter);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-success { color: var(--success); }
        .stat-warning { color: var(--warning); }
        .stat-danger { color: var(--danger); }
        .stat-primary { color: var(--primary); }
        
        .log {
            background: var(--darker);
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            border-left: 4px solid var(--primary);
        }
        
        .log-success { border-left-color: var(--success); background: rgba(0,210,106,0.1); }
        .log-error { border-left-color: var(--danger); background: rgba(255,0,128,0.1); }
        .log-warning { border-left-color: var(--warning); background: rgba(255,184,0,0.1); }
        .log-info { border-left-color: #2196F3; background: rgba(33,150,243,0.1); }
        
        .wallet-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .wallet-item {
            background: var(--lighter);
            padding: 15px;
            margin: 8px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .balance-item {
            background: var(--darker);
            padding: 12px;
            margin: 6px 0;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .status-active { background: var(--success); color: #000; }
        .status-inactive { background: var(--danger); color: #fff; }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîÑ Balance Consolidator - BSC</h1>
            <p>Sistema de consolida√ß√£o autom√°tica de saldos de m√∫ltiplas carteiras</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div>Saldo Contrato</div>
                <div class="stat-value stat-success" id="contractBalance">0 USDT</div>
                <div>Total Consolidado</div>
            </div>
            <div class="stat-card">
                <div>Carteiras Ativas</div>
                <div class="stat-value stat-primary" id="activeWallets">0/5</div>
                <div>Autorizadas</div>
            </div>
            <div class="stat-card">
                <div>√öltima Consolida√ß√£o</div>
                <div class="stat-value stat-warning" id="lastConsolidation">-</div>
                <div>Timestamp</div>
            </div>
            <div class="stat-card">
                <div>Saldo Principal</div>
                <div class="stat-value stat-success" id="mainBalance">0 BNB</div>
                <div>Carteira Conectada</div>
            </div>
        </div>

        <div class="grid">
            <!-- Coluna Esquerda -->
            <div>
                <!-- Conex√£o e Status -->
                <div class="card">
                    <div class="card-header">
                        <h3>üîó Conex√£o & Status</h3>
                    </div>
                    <button class="btn" id="connectWallet">Conectar MetaMask</button>
                    <span id="walletStatus" class="status-badge status-inactive">Desconectado</span>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <div id="walletInfo" style="font-size: 12px; color: #ccc;"></div>
                    </div>
                </div>

                <!-- Gerenciar Carteiras -->
                <div class="card">
                    <div class="card-header">
                        <h3>üëõ Gerenciar Carteiras</h3>
                    </div>
                    <div class="form-group">
                        <label>Endere√ßo da Carteira:</label>
                        <input type="text" id="walletAddress" placeholder="0x..." style="font-family: monospace;">
                    </div>
                    <div class="form-group">
                        <label>Apelido (Opcional):</label>
                        <input type="text" id="walletNickname" placeholder="Carteira Secund√°ria 1">
                    </div>
                    <button class="btn btn-success" id="addWallet">Autorizar Carteira</button>
                    <button class="btn btn-warning" id="checkApprovals">Verificar Aprova√ß√µes</button>
                </div>

                <!-- Carteiras Autorizadas -->
                <div class="card">
                    <div class="card-header">
                        <h3>üìã Carteiras Autorizadas</h3>
                    </div>
                    <div class="wallet-list" id="authorizedWallets">
                        <!-- Carteiras ser√£o listadas aqui -->
                    </div>
                </div>
            </div>

            <!-- Coluna Direita -->
            <div>
                <!-- Controle de Consolida√ß√£o -->
                <div class="card">
                    <div class="card-header">
                        <h3>üîÑ Controle de Consolida√ß√£o</h3>
                    </div>
                    <div class="form-group">
                        <label>Carteira para Consolidar:</label>
                        <select id="consolidateWallet">
                            <option value="all">TODAS AS CARTEIRAS</option>
                            <!-- Op√ß√µes preenchidas via JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Token para Consolidar:</label>
                        <select id="consolidateToken">
                            <option value="all">TODOS OS STABLECOINS</option>
                            <option value="USDT">USDT</option>
                            <option value="BUSD">BUSD</option>
                            <option value="USDC">USDC</option>
                        </select>
                    </div>
                    <button class="btn btn-success" id="consolidateBtn">Executar Consolida√ß√£o</button>
                    <button class="btn btn-warning" id="approveAllTokens">Aprovar Todos Tokens</button>
                    
                    <div style="margin-top: 15px;">
                        <label>Status:</label>
                        <div id="consolidationStatus" class="status-badge status-inactive">AGUARDANDO</div>
                    </div>
                </div>

                <!-- Gerenciar Fundos -->
                <div class="card">
                    <div class="card-header">
                        <h3>üè¶ Gerenciar Fundos</h3>
                    </div>
                    <div class="form-group">
                        <label>Token para Retirar:</label>
                        <select id="withdrawToken">
                            <option value="USDT">USDT</option>
                            <option value="BUSD">BUSD</option>
                            <option value="USDC">USDC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantidade:</label>
                        <input type="number" id="withdrawAmount" placeholder="Deixe vazio para retirar tudo">
                    </div>
                    <button class="btn btn-success" id="withdrawFunds">Retirar para Carteira</button>
                    <button class="btn" id="refreshBalances">Atualizar Saldos</button>
                </div>

                <!-- Saldos em Tempo Real -->
                <div class="card">
                    <div class="card-header">
                        <h3>üí∞ Saldos em Tempo Real</h3>
                    </div>
                    <div id="balancesDisplay" style="height: 200px; overflow-y: auto;">
                        <div class="balance-item">Conecte para ver saldos...</div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #ccc;">
                        <span id="balanceStats">Atualizado: -</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="card">
            <div class="card-header">
                <h3>üìù Logs de Execu√ß√£o</h3>
                <button class="btn" id="clearLogs">Limpar Logs</button>
            </div>
            <div class="log" id="logs"></div>
        </div>
    </div>

    <script>
        // ABI DO CONTRATO
        const contractABI = [
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "user",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "totalTokens",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "totalValue",
                "type": "uint256"
            }
        ],
        "name": "BulkConsolidation",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "token",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "amount",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "address",
                "name": "fromWallet",
                "type": "address"
            }
        ],
        "name": "TokensConsolidated",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "wallet",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "string",
                "name": "nickname",
                "type": "string"
            }
        ],
        "name": "WalletAuthorized",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "wallet",
                "type": "address"
            }
        ],
        "name": "WalletRemoved",
        "type": "event"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_wallet",
                "type": "address"
            },
            {
                "internalType": "string",
                "name": "_nickname",
                "type": "string"
            }
        ],
        "name": "authorizeWallet",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "BUSD",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "USDC",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "USDT",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_token",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_amount",
                "type": "uint256"
            }
        ],
        "name": "approveContractForTokens",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_wallet",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "_token",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_amount",
                "type": "uint256"
            }
        ],
        "name": "approveTokenForWallet",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "authorizedWallets",
        "outputs": [
            {
                "internalType": "address",
                "name": "walletAddress",
                "type": "address"
            },
            {
                "internalType": "string",
                "name": "nickname",
                "type": "string"
            },
            {
                "internalType": "bool",
                "name": "isActive",
                "type": "bool"
            },
            {
                "internalType": "uint256",
                "name": "lastConsolidation",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "consolidateAllWallets",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_wallet",
                "type": "address"
            }
        ],
        "name": "consolidateStablecoinsFromWallet",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_wallet",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "_token",
                "type": "address"
            }
        ],
        "name": "consolidateTokensFromWallet",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getAuthorizedWallets",
        "outputs": [
            {
                "components": [
                    {
                        "internalType": "address",
                        "name": "walletAddress",
                        "type": "address"
                    },
                    {
                        "internalType": "string",
                        "name": "nickname",
                        "type": "string"
                    },
                    {
                        "internalType": "bool",
                        "name": "isActive",
                        "type": "bool"
                    },
                    {
                        "internalType": "uint256",
                        "name": "lastConsolidation",
                        "type": "uint256"
                    }
                ],
                "internalType": "struct BalanceConsolidator.AuthorizedWallet[]",
                "name": "",
                "type": "tuple[]"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_token",
                "type": "address"
            }
        ],
        "name": "getContractBalance",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getWalletCount",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_wallet",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "_token",
                "type": "address"
            }
        ],
        "name": "getWalletBalance",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_wallet",
                "type": "address"
            }
        ],
        "name": "removeWallet",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "walletAddresses",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_token",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_amount",
                "type": "uint256"
            }
        ],
        "name": "withdrawFunds",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "stateMutability": "payable",
        "type": "receive"
    }
];
        
        let web3, contract, userAccount;
        const contractAddress = "0x0890eeE190B5cCf483942616C25395aE4f7B302B"; // INSERIR ENDERE√áO DO CONTRATO DEPLOYADO
        
        // Endere√ßos dos tokens
        const TOKENS = {
            USDT: "0x55d398326f99059fF775485246999027B3197955",
            BUSD: "0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56", 
            USDC: "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d"
        };

        // Estado da aplica√ß√£o
        let authorizedWallets = [];
        let isConsolidating = false;

        // Elementos da UI
        const elements = {
            // Conex√£o
            connectWallet: document.getElementById('connectWallet'),
            walletStatus: document.getElementById('walletStatus'),
            walletInfo: document.getElementById('walletInfo'),
            
            // Stats
            contractBalance: document.getElementById('contractBalance'),
            activeWallets: document.getElementById('activeWallets'),
            lastConsolidation: document.getElementById('lastConsolidation'),
            mainBalance: document.getElementById('mainBalance'),
            
            // Carteiras
            walletAddress: document.getElementById('walletAddress'),
            walletNickname: document.getElementById('walletNickname'),
            addWallet: document.getElementById('addWallet'),
            checkApprovals: document.getElementById('checkApprovals'),
            authorizedWallets: document.getElementById('authorizedWallets'),
            
            // Consolida√ß√£o
            consolidateWallet: document.getElementById('consolidateWallet'),
            consolidateToken: document.getElementById('consolidateToken'),
            consolidateBtn: document.getElementById('consolidateBtn'),
            approveAllTokens: document.getElementById('approveAllTokens'),
            consolidationStatus: document.getElementById('consolidationStatus'),
            
            // Fundos
            withdrawToken: document.getElementById('withdrawToken'),
            withdrawAmount: document.getElementById('withdrawAmount'),
            withdrawFunds: document.getElementById('withdrawFunds'),
            refreshBalances: document.getElementById('refreshBalances'),
            
            // Saldos
            balancesDisplay: document.getElementById('balancesDisplay'),
            balanceStats: document.getElementById('balanceStats'),
            
            // Logs
            logs: document.getElementById('logs'),
            clearLogs: document.getElementById('clearLogs')
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners
            elements.connectWallet.addEventListener('click', connectWallet);
            elements.addWallet.addEventListener('click', addWallet);
            elements.checkApprovals.addEventListener('click', checkTokenApprovals);
            elements.consolidateBtn.addEventListener('click', executeConsolidation);
            elements.approveAllTokens.addEventListener('click', approveAllTokens);
            elements.withdrawFunds.addEventListener('click', withdrawFunds);
            elements.refreshBalances.addEventListener('click', updateAllBalances);
            elements.clearLogs.addEventListener('click', () => elements.logs.innerHTML = '');
            
            addLog('Sistema de consolida√ß√£o inicializado. Conecte sua carteira para come√ßar.', 'info');
        });

        // Fun√ß√µes de utilidade
        function toWei(amount) { 
            return web3 ? web3.utils.toWei(amount.toString(), 'ether') : '0'; 
        }
        
        function fromWei(amount) { 
            return web3 ? web3.utils.fromWei(amount.toString(), 'ether') : '0'; 
        }

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);
                    userAccount = (await web3.eth.getAccounts())[0];
                    
                    elements.walletStatus.textContent = `Conectado: ${userAccount.substring(0, 8)}...`;
                    elements.walletStatus.className = 'status-badge status-active';
                    
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    
                    addLog('‚úÖ Carteira conectada com sucesso', 'success');
                    await updateAllInfo();
                    await loadAuthorizedWallets();
                    
                } catch (error) {
                    addLog(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                }
            } else {
                addLog('‚ùå MetaMask n√£o encontrado!', 'error');
            }
        }

        async function addWallet() {
            const walletAddress = elements.walletAddress.value;
            const nickname = elements.walletNickname.value || `Carteira ${authorizedWallets.length + 1}`;
            
            if (!web3.utils.isAddress(walletAddress)) {
                addLog('‚ùå Endere√ßo de carteira inv√°lido', 'error');
                return;
            }
            
            try {
                addLog(`üëõ Autorizando carteira ${walletAddress.substring(0, 10)}...`, 'info');
                
                await contract.methods.authorizeWallet(
                    walletAddress,
                    nickname
                ).send({ from: userAccount });
                
                addLog(`‚úÖ Carteira autorizada com sucesso: ${nickname}`, 'success');
                
                elements.walletAddress.value = '';
                elements.walletNickname.value = '';
                
                await loadAuthorizedWallets();
                await updateAllInfo();
                
            } catch (error) {
                addLog(`‚ùå Erro ao autorizar carteira: ${error.message}`, 'error');
            }
        }

        async function loadAuthorizedWallets() {
            try {
                const wallets = await contract.methods.getAuthorizedWallets().call();
                authorizedWallets = wallets.filter(w => w.isActive);
                
                elements.authorizedWallets.innerHTML = '';
                elements.consolidateWallet.innerHTML = '<option value="all">TODAS AS CARTEIRAS</option>';
                
                authorizedWallets.forEach(wallet => {
                    // Adicionar √† lista de carteiras
                    const walletElement = document.createElement('div');
                    walletElement.className = 'wallet-item';
                    walletElement.innerHTML = `
                        <div>
                            <strong>${wallet.nickname}</strong><br>
                            <small style="font-family: monospace">${wallet.walletAddress}</small>
                        </div>
                        <div>
                            <span class="status-badge status-active">ATIVA</span>
                            <button class="btn btn-danger" onclick="removeWallet('${wallet.walletAddress}')">Remover</button>
                        </div>
                    `;
                    elements.authorizedWallets.appendChild(walletElement);
                    
                    // Adicionar ao dropdown de consolida√ß√£o
                    const option = document.createElement('option');
                    option.value = wallet.walletAddress;
                    option.textContent = `${wallet.nickname} (${wallet.walletAddress.substring(0, 8)}...)`;
                    elements.consolidateWallet.appendChild(option);
                });
                
                elements.activeWallets.textContent = `${authorizedWallets.length}/5`;
                
            } catch (error) {
                addLog(`‚ùå Erro ao carregar carteiras: ${error.message}`, 'error');
            }
        }

        async function executeConsolidation() {
            if (isConsolidating) {
                addLog('‚ö†Ô∏è Consolida√ß√£o j√° em andamento', 'warning');
                return;
            }
            
            const wallet = elements.consolidateWallet.value;
            const token = elements.consolidateToken.value;
            
            try {
                isConsolidating = true;
                elements.consolidationStatus.textContent = 'CONSOLIDANDO...';
                elements.consolidationStatus.className = 'status-badge status-warning';
                
                addLog(`üîÑ Iniciando consolida√ß√£o...`, 'info');
                
                let result;
                if (wallet === 'all') {
                    addLog('üì¶ Consolidando TODAS as carteiras...', 'info');
                    result = await contract.methods.consolidateAllWallets().send({ from: userAccount });
                } else if (token === 'all') {
                    addLog(`üí∞ Consolidando stablecoins da carteira...`, 'info');
                    result = await contract.methods.consolidateStablecoinsFromWallet(wallet).send({ from: userAccount });
                } else {
                    addLog(`ü™ô Consolidando ${token} da carteira...`, 'info');
                    const tokenAddress = TOKENS[token];
                    result = await contract.methods.consolidateTokensFromWallet(wallet, tokenAddress).send({ from: userAccount });
                }
                
                addLog(`‚úÖ Consolida√ß√£o conclu√≠da com sucesso!`, 'success');
                elements.consolidationStatus.textContent = 'CONCLU√çDO';
                elements.consolidationStatus.className = 'status-badge status-success';
                
                await updateAllBalances();
                
            } catch (error) {
                addLog(`‚ùå Erro na consolida√ß√£o: ${error.message}`, 'error');
                elements.consolidationStatus.textContent = 'ERRO';
                elements.consolidationStatus.className = 'status-badge status-danger';
            } finally {
                isConsolidating = false;
            }
        }

        async function checkTokenApprovals() {
            addLog('üîç Verificando aprova√ß√µes de tokens...', 'info');
            
            for (const wallet of authorizedWallets) {
                for (const [tokenName, tokenAddress] of Object.entries(TOKENS)) {
                    try {
                        const tokenContract = new web3.eth.Contract([
                            {
                                "constant": true,
                                "inputs": [
                                    {"name": "_owner", "type": "address"},
                                    {"name": "_spender", "type": "address"}
                                ],
                                "name": "allowance",
                                "outputs": [{"name": "", "type": "uint256"}],
                                "type": "function"
                            }
                        ], tokenAddress);
                        
                        const allowance = await tokenContract.methods.allowance(
                            wallet.walletAddress,
                            contractAddress
                        ).call();
                        
                        if (allowance > 0) {
                            addLog(`‚úÖ ${tokenName} aprovado para ${wallet.nickname}: ${fromWei(allowance)}`, 'success');
                        } else {
                            addLog(`‚ùå ${tokenName} N√ÉO aprovado para ${wallet.nickname}`, 'warning');
                        }
                    } catch (error) {
                        addLog(`‚ö†Ô∏è Erro ao verificar ${tokenName} para ${wallet.nickname}`, 'warning');
                    }
                }
            }
        }

        async function approveAllTokens() {
            addLog('‚úÖ Aprovando todos os tokens...', 'info');
            
            for (const wallet of authorizedWallets) {
                for (const [tokenName, tokenAddress] of Object.entries(TOKENS)) {
                    try {
                        const tokenContract = new web3.eth.Contract([
                            {
                                "constant": false,
                                "inputs": [
                                    {"name": "_spender", "type": "address"},
                                    {"name": "_value", "type": "uint256"}
                                ],
                                "name": "approve",
                                "outputs": [{"name": "", "type": "bool"}],
                                "type": "function"
                            }
                        ], tokenAddress);
                        
                        await tokenContract.methods.approve(
                            contractAddress,
                            web3.utils.toWei('1000000', 'ether') // Aprova√ß√£o alta
                        ).send({ from: userAccount });
                        
                        addLog(`‚úÖ ${tokenName} aprovado para ${wallet.nickname}`, 'success');
                        
                    } catch (error) {
                        addLog(`‚ùå Erro ao aprovar ${tokenName} para ${wallet.nickname}: ${error.message}`, 'error');
                    }
                }
            }
        }

        async function withdrawFunds() {
            const token = elements.withdrawToken.value;
            const amount = elements.withdrawAmount.value;
            const tokenAddress = TOKENS[token];
            
            try {
                addLog(`üè¶ Retirando ${token}...`, 'info');
                
                let tx;
                if (amount) {
                    tx = await contract.methods.withdrawFunds(
                        tokenAddress,
                        toWei(amount)
                    ).send({ from: userAccount });
                } else {
                    // Retirar tudo
                    const balance = await contract.methods.getContractBalance(tokenAddress).call();
                    tx = await contract.methods.withdrawFunds(
                        tokenAddress,
                        balance
                    ).send({ from: userAccount });
                }
                
                addLog(`‚úÖ ${token} retirado com sucesso!`, 'success');
                elements.withdrawAmount.value = '';
                
                await updateAllBalances();
                
            } catch (error) {
                addLog(`‚ùå Erro ao retirar fundos: ${error.message}`, 'error');
            }
        }

        async function updateAllBalances() {
            try {
                // Saldo do contrato
                const usdtBalance = await contract.methods.getContractBalance(TOKENS.USDT).call();
                elements.contractBalance.textContent = `${fromWei(usdtBalance)} USDT`;
                
                // Saldo principal (BNB)
                const bnbBalance = await web3.eth.getBalance(userAccount);
                elements.mainBalance.textContent = `${fromWei(bnbBalance)} BNB`;
                
                // Atualizar display de saldos
                elements.balancesDisplay.innerHTML = '';
                
                for (const [tokenName, tokenAddress] of Object.entries(TOKENS)) {
                    const balance = await contract.methods.getContractBalance(tokenAddress).call();
                    const balanceElement = document.createElement('div');
                    balanceElement.className = 'balance-item';
                    balanceElement.innerHTML = `
                        <strong>${tokenName}</strong>: ${fromWei(balance)} tokens
                    `;
                    elements.balancesDisplay.appendChild(balanceElement);
                }
                
                elements.balanceStats.textContent = `Atualizado: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                addLog(`‚ùå Erro ao atualizar saldos: ${error.message}`, 'error');
            }
        }

        async function updateAllInfo() {
            await updateAllBalances();
            await loadAuthorizedWallets();
        }

        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            elements.logs.appendChild(logEntry);
            elements.logs.scrollTop = elements.logs.scrollHeight;
        }

        // Fun√ß√µes globais para bot√µes
        window.removeWallet = async function(walletAddress) {
            try {
                addLog(`üóëÔ∏è Removendo carteira...`, 'info');
                await contract.methods.removeWallet(walletAddress).send({ from: userAccount });
                addLog(`‚úÖ Carteira removida com sucesso`, 'success');
                await loadAuthorizedWallets();
            } catch (error) {
                addLog(`‚ùå Erro ao remover carteira: ${error.message}`, 'error');
            }
        };

        // Listeners para eventos do contrato
        if (contract) {
            contract.events.WalletAuthorized({}, (error, event) => {
                if (!error) addLog(`üëõ Nova carteira autorizada: ${event.returnValues.nickname}`, 'success');
            });
            
            contract.events.TokensConsolidated({}, (error, event) => {
                if (!error) addLog(`üí∞ Tokens consolidados: ${fromWei(event.returnValues.amount)}`, 'success');
            });
        }
    </script>
</body>
</html>
