<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polygon Arbitrage Bot - Retirada de USDT</title>
    <style>
        :root {
            --primary-color: #8247e5;
            --secondary-color: #2e2e2e;
            --accent-color: #00d395;
            --text-color: #e0e0e0;
            --background-color: #1a1a1a;
            --card-bg: #252525;
            --success-color: #00d395;
            --error-color: #ff6b6b;
            --warning-color: #ffb74d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .subtitle {
            color: #aaa;
            font-size: 1.1rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .card-title i {
            font-size: 1.8rem;
        }

        .wallet-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .wallet-section {
                grid-template-columns: 1fr;
            }
        }

        .wallet-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background-color: #2e2e2e;
            border-radius: 10px;
            border-left: 4px solid var(--accent-color);
        }

        .info-label {
            font-weight: bold;
            color: #aaa;
        }

        .info-value {
            font-family: monospace;
            color: var(--text-color);
            word-break: break-all;
        }

        .balance-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .balance-card {
            background: linear-gradient(135deg, #2e2e2e, #252525);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #444;
        }

        .balance-amount {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 15px 0;
            color: var(--accent-color);
        }

        .token-name {
            color: #aaa;
            font-size: 1.1rem;
        }

        .withdraw-section {
            text-align: center;
        }

        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #6a3bc0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(130, 71, 229, 0.4);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #00b884;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 211, 149, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            background-color: #2e2e2e;
            min-height: 60px;
        }

        .status-message {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .status-success {
            color: var(--success-color);
        }

        .status-error {
            color: var(--error-color);
        }

        .status-warning {
            color: var(--warning-color);
        }

        .status-loading {
            color: var(--primary-color);
        }

        .loading-spinner {
            border: 3px solid #333;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            color: #777;
            font-size: 0.9rem;
        }

        .contract-address {
            font-family: monospace;
            background-color: #2e2e2e;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: inline-block;
            color: var(--accent-color);
        }

        .hidden {
            display: none !important;
        }

        .network-info {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--primary-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 15px;
        }

        .wallet-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">PAB</div>
                <div>
                    <h1>Polygon Arbitrage Bot</h1>
                    <p class="subtitle">Interface para retirada de ganhos em USDT</p>
                </div>
            </div>
            
            <div class="contract-address">
                <i class="fas fa-file-contract"></i>
                Contrato: 0x353a3834047b769f4c38365f22257e7e32d38710
            </div>
        </header>

        <div class="card">
            <div class="card-title">
                <i class="fas fa-wallet"></i>
                <span>Carteira Web3</span>
                <div class="network-info" id="networkInfo">
                    <i class="fas fa-circle"></i>
                    <span>Desconectado</span>
                </div>
            </div>
            
            <div class="wallet-section">
                <div class="wallet-info">
                    <div class="info-item">
                        <span class="info-label">Status da Carteira:</span>
                        <span class="info-value" id="walletStatus">Não conectada</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Endereço:</span>
                        <span class="info-value" id="walletAddress">N/A</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rede:</span>
                        <span class="info-value" id="networkName">N/A</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Saldo POL:</span>
                        <span class="info-value" id="maticBalance">0 POL</span>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <button id="connectWalletBtn" class="btn btn-primary">
                        <i class="fas fa-plug"></i>
                        Conectar Carteira
                    </button>
                    <p style="margin-top: 15px; text-align: center; color: #aaa; max-width: 300px;">
                        Conecte sua carteira MetaMask ou Rabby Wallet para gerenciar seus ganhos do bot de arbitragem
                    </p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <i class="fas fa-coins"></i>
                <span>Saldos do Contrato</span>
            </div>
            
            <div class="balance-section">
                <div class="balance-card">
                    <i class="fas fa-dollar-sign" style="font-size: 2rem; color: #00d395;"></i>
                    <div class="balance-amount" id="usdtBalance">0.00</div>
                    <div class="token-name">USDT (Polygon)</div>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #aaa;">Saldo disponível para retirada</p>
                </div>
                
                <div class="balance-card">
                    <i class="fab fa-bitcoin" style="font-size: 2rem; color: #f7931a;"></i>
                    <div class="balance-amount" id="wbtcBalance">0.00</div>
                    <div class="token-name">WBTC</div>
                </div>
                
                <div class="balance-card">
                    <i class="fas fa-gas-pump" style="font-size: 2rem; color: #8247e5;"></i>
                    <div class="balance-amount" id="wmaticBalance">0.00</div>
                    <div class="token-name">WMATIC</div>
                </div>
            </div>
            
            <div class="withdraw-section">
                <div class="wallet-actions">
                    <button id="refreshBalancesBtn" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        Atualizar Saldos
                    </button>
                    
                    <button id="withdrawUsdtBtn" class="btn btn-success" disabled>
                        <i class="fas fa-money-bill-wave"></i>
                        Retirar USDT
                    </button>
                    
                    <button id="withdrawAllBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-boxes"></i>
                        Retirar Todos os Tokens
                    </button>
                </div>
                
                <div class="status-container">
                    <div id="statusMessage" class="status-message">
                        <i class="fas fa-info-circle"></i>
                        <span>Conecte sua carteira para começar</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">
                <i class="fas fa-history"></i>
                <span>Histórico de Transações</span>
            </div>
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-clock" style="font-size: 3rem; color: #555; margin-bottom: 15px;"></i>
                <p style="color: #aaa;">Histórico de transações disponível após conexão da carteira</p>
                <button id="viewOnPolygonscanBtn" class="btn btn-primary" style="margin-top: 20px;">
                    <i class="fas fa-external-link-alt"></i>
                    Ver no Polygonscan
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2025 Polygon Arbitrage Bot Interface | Contrato implantado na rede Polygon</p>
            <p style="margin-top: 10px; font-size: 0.8rem;">
                <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
                Certifique-se de estar conectado à rede Polygon (Chain ID: 137) para interagir com este contrato
            </p>
        </div>
    </div>

    <script>
        // ABI do contrato obtida do Polygonscan
        const contractABI = [{"inputs":[{"internalType":"address","name":"_routerAddress","type":"address"},{"internalType":"address","name":"_aavePoolAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"USDT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"WBTC","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"WMATIC","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"aavePool","outputs":[{"internalType":"contract IPool","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"executeArbitrage","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"assets","type":"address[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"},{"internalType":"uint256[]","name":"premiums","type":"uint256[]"},{"internalType":"address","name":"initiator","type":"address"},{"internalType":"bytes","name":"params","type":"bytes"}],"name":"executeOperation","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"router","outputs":[{"internalType":"contract IUniswapV2Router02","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

        // Endereço do contrato Polygon Arbitrage Bot
        const contractAddress = "0x353a3834047b769f4c38365f22257e7e32d38710";
        
        // Endereços dos tokens na Polygon
        const tokenAddresses = {
            USDT: "0xc2132D05D31c914a87C6611C10748AEb04B58e8F",
            WBTC: "0x1BFD67037B42Cf73acF2047067bd4F2C47D9BfD6",
            WMATIC: "0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270"
        };
        
        // Configurações da rede Polygon
        const polygonNetwork = {
            chainId: "0x89", // 137 em hexadecimal
            chainName: "Polygon Mainnet",
            nativeCurrency: {
                name: "MATIC",
                symbol: "MATIC",
                decimals: 18
            },
            rpcUrls: ["https://polygon-rpc.com/"],
            blockExplorerUrls: ["https://polygonscan.com/"]
        };

        // Variáveis globais
        let web3;
        let userAccount = null;
        let contractInstance = null;
        let provider = null;

        // Elementos DOM
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const refreshBalancesBtn = document.getElementById('refreshBalancesBtn');
        const withdrawUsdtBtn = document.getElementById('withdrawUsdtBtn');
        const withdrawAllBtn = document.getElementById('withdrawAllBtn');
        const viewOnPolygonscanBtn = document.getElementById('viewOnPolygonscanBtn');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddress = document.getElementById('walletAddress');
        const networkName = document.getElementById('networkName');
        const maticBalance = document.getElementById('maticBalance');
        const usdtBalance = document.getElementById('usdtBalance');
        const wbtcBalance = document.getElementById('wbtcBalance');
        const wmaticBalance = document.getElementById('wmaticBalance');
        const networkInfo = document.getElementById('networkInfo');
        const statusMessage = document.getElementById('statusMessage');

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se há uma carteira Web3 disponível
            if (typeof window.ethereum !== 'undefined') {
                provider = window.ethereum;
                updateStatus("Carteira Web3 detectada", "success");
                setupEventListeners();
                checkIfWalletIsConnected();
            } else {
                updateStatus("Nenhuma carteira Web3 detectada. Instale MetaMask ou Rabby Wallet.", "error");
                connectWalletBtn.disabled = true;
                connectWalletBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Carteira Não Detectada';
            }
        });

        // Configurar listeners de eventos
        function setupEventListeners() {
            connectWalletBtn.addEventListener('click', connectWallet);
            refreshBalancesBtn.addEventListener('click', refreshAllBalances);
            withdrawUsdtBtn.addEventListener('click', withdrawUSDT);
            withdrawAllBtn.addEventListener('click', withdrawAllTokens);
            viewOnPolygonscanBtn.addEventListener('click', () => {
                window.open(`https://polygonscan.com/address/${contractAddress}`, '_blank');
            });
            
            // Listener para mudanças de conta
            if (provider) {
                provider.on('accountsChanged', handleAccountsChanged);
                provider.on('chainChanged', handleChainChanged);
                provider.on('disconnect', handleDisconnect);
            }
        }

        // Conectar carteira
        async function connectWallet() {
            try {
                updateStatus("Conectando à carteira...", "loading");
                
                // Solicitar acesso às contas
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                
                if (accounts.length === 0) {
                    throw new Error("Nenhuma conta encontrada");
                }
                
                userAccount = accounts[0];
                
                // Verificar se estamos na rede Polygon
                const chainId = await provider.request({ method: 'eth_chainId' });
                
                if (chainId !== polygonNetwork.chainId) {
                    updateStatus("Por favor, alterne para a rede Polygon", "warning");
                    await switchToPolygonNetwork();
                } else {
                    await initializeApp();
                }
                
            } catch (error) {
                console.error("Erro ao conectar carteira:", error);
                updateStatus(`Erro: ${error.message}`, "error");
            }
        }

        // Inicializar aplicação após conexão
        async function initializeApp() {
            try {
                updateStatus("Inicializando contrato...", "loading");
                
                // Inicializar Web3
                if (typeof Web3 !== 'undefined') {
                    web3 = new Web3(provider);
                } else {
                    updateStatus("Biblioteca Web3 não carregada. Recarregue a página.", "error");
                    return;
                }
                
                // Criar instância do contrato
                contractInstance = new web3.eth.Contract(contractABI, contractAddress);
                
                // Atualizar interface
                updateWalletInfo();
                await refreshAllBalances();
                
                updateStatus("Carteira conectada com sucesso!", "success");
                
            } catch (error) {
                console.error("Erro ao inicializar aplicação:", error);
                updateStatus(`Erro de inicialização: ${error.message}`, "error");
            }
        }

        // Atualizar informações da carteira
        function updateWalletInfo() {
            if (!userAccount) return;
            
            walletStatus.textContent = "Conectada";
            walletStatus.style.color = "var(--success-color)";
            
            // Formatar endereço (mostrar início e fim)
            const formattedAddress = `${userAccount.substring(0, 6)}...${userAccount.substring(userAccount.length - 4)}`;
            walletAddress.textContent = formattedAddress;
            
            networkName.textContent = "Polygon Mainnet";
            networkInfo.innerHTML = '<i class="fas fa-circle" style="color: var(--success-color);"></i><span>Polygon Conectado</span>';
            
            // Atualizar botões
            connectWalletBtn.innerHTML = '<i class="fas fa-check"></i> Conectado';
            connectWalletBtn.disabled = true;
            withdrawUsdtBtn.disabled = false;
            withdrawAllBtn.disabled = false;
        }

        // Atualizar todos os saldos
        async function refreshAllBalances() {
            if (!web3 || !userAccount || !contractInstance) {
                updateStatus("Conecte sua carteira primeiro", "warning");
                return;
            }
            
            try {
                updateStatus("Atualizando saldos...", "loading");
                
                // Obter saldo de MATIC
                const maticWei = await web3.eth.getBalance(userAccount);
                const maticFormatted = web3.utils.fromWei(maticWei, 'ether');
                maticBalance.textContent = `${parseFloat(maticFormatted).toFixed(4)} POL`;
                
                // Obter endereços dos tokens do contrato
                let usdtTokenAddress, wbtcTokenAddress, wmaticTokenAddress;
                
                try {
                    usdtTokenAddress = await contractInstance.methods.USDT().call();
                    wbtcTokenAddress = await contractInstance.methods.WBTC().call();
                    wmaticTokenAddress = await contractInstance.methods.WMATIC().call();
                } catch (error) {
                    // Se não conseguir obter do contrato, usar endereços padrão
                    usdtTokenAddress = tokenAddresses.USDT;
                    wbtcTokenAddress = tokenAddresses.WBTC;
                    wmaticTokenAddress = tokenAddresses.WMATIC;
                }
                
                // ABI mínima para ler saldo de token ERC-20
                const erc20ABI = [
                    {
                        "constant": true,
                        "inputs": [{"name": "_owner", "type": "address"}],
                        "name": "balanceOf",
                        "outputs": [{"name": "balance", "type": "uint256"}],
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [],
                        "name": "decimals",
                        "outputs": [{"name": "", "type": "uint8"}],
                        "type": "function"
                    }
                ];
                
                // Função auxiliar para obter saldo de token
                async function getTokenBalance(tokenAddress, account) {
                    try {
                        const tokenContract = new web3.eth.Contract(erc20ABI, tokenAddress);
                        const balance = await tokenContract.methods.balanceOf(account).call();
                        const decimals = await tokenContract.methods.decimals().call();
                        return balance / (10 ** decimals);
                    } catch (error) {
                        console.error(`Erro ao obter saldo do token ${tokenAddress}:`, error);
                        return 0;
                    }
                }
                
                // Obter saldos dos tokens do contrato
                const contractUsdtBalance = await getTokenBalance(usdtTokenAddress, contractAddress);
                const contractWbtcBalance = await getTokenBalance(wbtcTokenAddress, contractAddress);
                const contractWmaticBalance = await getTokenBalance(wmaticTokenAddress, contractAddress);
                
                // Atualizar interface
                usdtBalance.textContent = contractUsdtBalance.toFixed(4);
                wbtcBalance.textContent = contractWbtcBalance.toFixed(4);
                wmaticBalance.textContent = contractWmaticBalance.toFixed(4);
                
                // Verificar se há saldo para retirada
                if (contractUsdtBalance > 0) {
                    withdrawUsdtBtn.disabled = false;
                    updateStatus("Saldos atualizados. USDT disponível para retirada.", "success");
                } else {
                    withdrawUsdtBtn.disabled = true;
                    updateStatus("Saldos atualizados. Sem USDT disponível no contrato.", "warning");
                }
                
                // Verificar se há qualquer saldo para retirada total
                if (contractUsdtBalance > 0 || contractWbtcBalance > 0 || contractWmaticBalance > 0) {
                    withdrawAllBtn.disabled = false;
                } else {
                    withdrawAllBtn.disabled = true;
                }
                
            } catch (error) {
                console.error("Erro ao atualizar saldos:", error);
                updateStatus(`Erro ao atualizar saldos: ${error.message}`, "error");
            }
        }

        // Retirar USDT do contrato
        async function withdrawUSDT() {
            if (!contractInstance || !userAccount) {
                updateStatus("Conecte sua carteira primeiro", "warning");
                return;
            }
            
            try {
                updateStatus("Iniciando retirada de USDT...", "loading");
                withdrawUsdtBtn.disabled = true;
                
                // Obter endereço do token USDT
                const usdtTokenAddress = await contractInstance.methods.USDT().call();
                
                // Chamar função withdraw do contrato
                const tx = await contractInstance.methods.withdraw(usdtTokenAddress).send({
                    from: userAccount,
                    gas: 300000
                });
                
                updateStatus(`Retirada de USDT confirmada! Hash: ${tx.transactionHash.substring(0, 10)}...`, "success");
                
                // Atualizar saldos após transação
                setTimeout(refreshAllBalances, 5000);
                
            } catch (error) {
                console.error("Erro ao retirar USDT:", error);
                updateStatus(`Erro na retirada: ${error.message}`, "error");
                withdrawUsdtBtn.disabled = false;
            }
        }

        // Retirar todos os tokens do contrato
        async function withdrawAllTokens() {
            if (!contractInstance || !userAccount) {
                updateStatus("Conecte sua carteira primeiro", "warning");
                return;
            }
            
            try {
                updateStatus("Iniciando retirada de todos os tokens...", "loading");
                withdrawAllBtn.disabled = true;
                
                // Obter endereços dos tokens
                const usdtTokenAddress = await contractInstance.methods.USDT().call();
                const wbtcTokenAddress = await contractInstance.methods.WBTC().call();
                const wmaticTokenAddress = await contractInstance.methods.WMATIC().call();
                
                // ABI mínima para ler saldo de token ERC-20
                const erc20ABI = [
                    {
                        "constant": true,
                        "inputs": [{"name": "_owner", "type": "address"}],
                        "name": "balanceOf",
                        "outputs": [{"name": "balance", "type": "uint256"}],
                        "type": "function"
                    }
                ];
                
                // Verificar quais tokens têm saldo
                const web3 = new Web3(provider);
                const tokensWithBalance = [];
                
                async function checkTokenBalance(tokenAddress) {
                    try {
                        const tokenContract = new web3.eth.Contract(erc20ABI, tokenAddress);
                        const balance = await tokenContract.methods.balanceOf(contractAddress).call();
                        return balance > 0;
                    } catch (error) {
                        return false;
                    }
                }
                
                // Verificar saldos
                if (await checkTokenBalance(usdtTokenAddress)) tokensWithBalance.push(usdtTokenAddress);
                if (await checkTokenBalance(wbtcTokenAddress)) tokensWithBalance.push(wbtcTokenAddress);
                if (await checkTokenBalance(wmaticTokenAddress)) tokensWithBalance.push(wmaticTokenAddress);
                
                if (tokensWithBalance.length === 0) {
                    updateStatus("Nenhum token disponível para retirada", "warning");
                    withdrawAllBtn.disabled = false;
                    return;
                }
                
                // Retirar cada token com saldo
                let successCount = 0;
                for (const tokenAddress of tokensWithBalance) {
                    try {
                        const tx = await contractInstance.methods.withdraw(tokenAddress).send({
                            from: userAccount,
                            gas: 300000
                        });
                        successCount++;
                    } catch (error) {
                        console.error(`Erro ao retirar token ${tokenAddress}:`, error);
                    }
                }
                
                updateStatus(`Retirada concluída! ${successCount} de ${tokensWithBalance.length} tokens retirados.`, "success");
                
                // Atualizar saldos após transação
                setTimeout(refreshAllBalances, 5000);
                
            } catch (error) {
                console.error("Erro ao retirar tokens:", error);
                updateStatus(`Erro na retirada: ${error.message}`, "error");
                withdrawAllBtn.disabled = false;
            }
        }

        // Alternar para rede Polygon
        async function switchToPolygonNetwork() {
            try {
                updateStatus("Alternando para rede Polygon...", "loading");
                
                await provider.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: polygonNetwork.chainId }]
                });
                
                // Se chegamos aqui, a troca foi bem-sucedida
                await initializeApp();
                
            } catch (switchError) {
                // Se a rede não estiver adicionada, tentar adicioná-la
                if (switchError.code === 4902) {
                    try {
                        await provider.request({
                            method: 'wallet_addEthereumChain',
                            params: [polygonNetwork]
                        });
                        await initializeApp();
                    } catch (addError) {
                        updateStatus(`Erro ao adicionar rede Polygon: ${addError.message}`, "error");
                    }
                } else {
                    updateStatus(`Erro ao alternar rede: ${switchError.message}`, "error");
                }
            }
        }

        // Verificar se a carteira já está conectada
        async function checkIfWalletIsConnected() {
            if (!provider) return;
            
            try {
                const accounts = await provider.request({ method: 'eth_accounts' });
                
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    const chainId = await provider.request({ method: 'eth_chainId' });
                    
                    if (chainId === polygonNetwork.chainId) {
                        await initializeApp();
                    } else {
                        updateStatus("Conectado à rede errada. Por favor, alterne para Polygon.", "warning");
                        walletStatus.textContent = "Rede Incorreta";
                        walletStatus.style.color = "var(--warning-color)";
                        walletAddress.textContent = `${userAccount.substring(0, 6)}...`;
                    }
                }
            } catch (error) {
                console.error("Erro ao verificar conexão da carteira:", error);
            }
        }

        // Manipuladores de eventos do provedor
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // Usuário desconectou a carteira
                handleDisconnect();
            } else if (accounts[0] !== userAccount) {
                userAccount = accounts[0];
                if (contractInstance) {
                    updateWalletInfo();
                    refreshAllBalances();
                }
            }
        }

        function handleChainChanged(chainId) {
            if (chainId === polygonNetwork.chainId) {
                // Reconectar se estiver na Polygon
                if (userAccount) {
                    initializeApp();
                }
            } else {
                // Atualizar status se estiver em outra rede
                networkName.textContent = "Rede não suportada";
                networkInfo.innerHTML = '<i class="fas fa-circle" style="color: var(--error-color);"></i><span>Rede Incorreta</span>';
                updateStatus("Por favor, alterne para a rede Polygon", "error");
            }
        }

        function handleDisconnect() {
            userAccount = null;
            contractInstance = null;
            
            // Resetar interface
            walletStatus.textContent = "Não conectada";
            walletStatus.style.color = "";
            walletAddress.textContent = "N/A";
            networkName.textContent = "N/A";
            maticBalance.textContent = "0 POL";
            usdtBalance.textContent = "0.00";
            wbtcBalance.textContent = "0.00";
            wmaticBalance.textContent = "0.00";
            
            networkInfo.innerHTML = '<i class="fas fa-circle"></i><span>Desconectado</span>';
            
            connectWalletBtn.innerHTML = '<i class="fas fa-plug"></i> Conectar Carteira';
            connectWalletBtn.disabled = false;
            withdrawUsdtBtn.disabled = true;
            withdrawAllBtn.disabled = true;
            
            updateStatus("Carteira desconectada", "warning");
        }

        // Atualizar mensagem de status
        function updateStatus(message, type = "info") {
            // Limpar classes anteriores
            statusMessage.className = "status-message";
            
            // Adicionar classe baseada no tipo
            statusMessage.classList.add(`status-${type}`);
            
            // Definir ícone baseado no tipo
            let icon = "info-circle";
            if (type === "success") icon = "check-circle";
            if (type === "error") icon = "exclamation-circle";
            if (type === "warning") icon = "exclamation-triangle";
            if (type === "loading") icon = "spinner";
            
            // Atualizar conteúdo
            if (type === "loading") {
                statusMessage.innerHTML = `<div class="loading-spinner"></div><span>${message}</span>`;
            } else {
                statusMessage.innerHTML = `<i class="fas fa-${icon}"></i><span>${message}</span>`;
            }
        }
    </script>
    
    <!-- Incluir Web3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.10.0/web3.min.js"></script>
</body>
</html>
